<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomberman</title>
    <style type="text/css">
        @font-face {
            font-family: 'DBZ';
            src: url('Fonts/Saiyan-Sans.ttf') format('truetype');
        }

        body {
            background-color: gray;
        }

        canvas {
            background-color: rgb(47, 143, 28);
            display: block;
            margin: 0 auto;
        }

        #info {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            color: white;
        }

        #left-panel,
        #right-panel {
            width: 150px;
        }
    </style>
</head>

<body>
    <div id="info">
        <div id="left-panel">
            <h3>Score:</h3>
            <p id="score">0</p>
            <h3>Timer:</h3>
            <p id="time">0</p>
        </div>
        <div id="right-panel">
            <h3>¿Cómo jugar?</h3>
            <p>Muévete con WASD o las flechas</p>
            <p>Pon una bomba con B</p>
        </div>
    </div>

    <canvas id="myCanvas" width="900" height="700"></canvas>

    <script>
        const myCanvas = document.getElementById("myCanvas");
        const ctx = myCanvas.getContext("2d");

        let gameStarted = false;
        let dir = "";
        let vel = 2;
        let muros = [];
        let bombas = [];
        const explosionDuration = 1800; 
        const explosionDisplayTime = 500; 
        const explosion = new Image();
        explosion.src = 'explosion.png';
        explosion.onload = () => {
            console.log('Explosion image loaded successfully');
        };
        explosion.onerror = () => {
            console.error('Failed to load explosion image');
        };

        const genkidama = new Image();
        genkidama.src = 'genkidama1.png';
        genkidama.onload = () => {
            console.log('Genkidama image loaded successfully');
        };
        genkidama.onerror = () => {
            console.error('Failed to load genkidama image');
        };

        class Rectangulo {
            constructor(axisX, axisY, width, height, fillColor, vel, destructible = false) {
                this.axisX = axisX;
                this.axisY = axisY;
                this.width = width;
                this.height = height;
                this.fillColor = fillColor;
                this.vel = vel;
                this.destructible = destructible;
            }

            deteccionColision(otro) {
                return (this.axisX < otro.axisX + otro.width &&
                    this.axisX + this.width > otro.axisX &&
                    this.axisY < otro.axisY + otro.height &&
                    this.axisY + this.height > otro.axisY);
            }
        }

        class Bomba {
            constructor(axisX, axisY, size) {
                this.axisX = axisX;
                this.axisY = axisY;
                this.size = size;
                this.exploded = false;
                this.timePlaced = Date.now();
                this.explosionStartTime = 0; 
                this.scale = 1.5;
            }

            explotar() {
                this.exploded = true;
                this.explosionStartTime = Date.now(); 
            }

            deteccionColision(otro) {
                return (
                    this.axisX < otro.axisX + otro.width &&
                    this.axisX + this.size > otro.axisX &&
                    this.axisY < otro.axisY + otro.height &&
                    this.axisY + this.size > otro.axisY
                );
            }

            estaDentroRango(otro) {
                const rangoExplosion = this.size * 3;
                return (
                    Math.abs(this.axisX - otro.axisX) < rangoExplosion &&
                    Math.abs(this.axisY - otro.axisY) < rangoExplosion
                );
            }
        }

        const jugador = new Rectangulo(100, 100, 20, 20, "green", 5);

        muros.push(new Rectangulo(0, 0, 900, 20, "black", null)); 
        muros.push(new Rectangulo(0, 0, 20, 700, "black", null)); 
        muros.push(new Rectangulo(880, 0, 20, 700, "black", null)); 
        muros.push(new Rectangulo(0, 680, 900, 20, "black", null)); 
        function Sound(src, volume = 0.7) {
            this.sound = document.createElement("audio");
            this.sound.src = src;
            this.sound.setAttribute("preload", "auto");
            this.sound.setAttribute("controls", "none");
            this.sound.style.display = "none";
            this.sound.volume = volume; 
            document.body.appendChild(this.sound);
            this.play = function () {
                this.sound.currentTime = 0;
                this.sound.play();
            }
            this.stop = function () {
                this.sound.pause();
            }
        }

        const musica = new Sound("Numb8bit.mp3", 0.7);
        const lanzarGenkidama = new Sound("throwBomb.mp3", 0.7);
        const explotaGenkidama = new Sound("explodeBomb.mp3", 0.7); 

        document.addEventListener("keydown", function (e) {
            if (e.code === "Enter" && !gameStarted) {
                gameStarted = true;
                musica.play();
                requestAnimationFrame(pintar);
            }

            if (gameStarted) {
                switch (e.key) {
                    case "w":
                        dir = "arriba";
                        break;
                    case "s":
                        dir = "abajo";
                        break;
                    case "a":
                        dir = "izquierda";
                        break;
                    case "d":
                        dir = "derecha";
                        break;
                    case "b":
                        bombas.push(new Bomba(jugador.axisX, jugador.axisY, 20));
                        lanzarGenkidama.play();
                        break;
                }
            }
        });

        function actualizar() {
            switch (dir) {
                case 'arriba':
                    jugador.axisY -= vel;
                    break;
                case 'abajo':
                    jugador.axisY += vel;
                    break;
                case 'derecha':
                    jugador.axisX += vel;
                    break;
                case 'izquierda':
                    jugador.axisX -= vel;
                    break;
            }

            muros.forEach(function (muro) {
                if (jugador.deteccionColision(muro)) {
                    switch (dir) {
                        case 'arriba':
                            jugador.axisY += vel;
                            break;
                        case 'abajo':
                            jugador.axisY -= vel;
                            break;
                        case 'derecha':
                            jugador.axisX -= vel;
                            break;
                        case 'izquierda':
                            jugador.axisX += vel;
                            break;
                    }
                }
            });

            bombas = bombas.filter((bomba) => {
                if (Date.now() - bomba.timePlaced >= explosionDuration) {
                    if (!bomba.exploded) {
                        bomba.explotar();
                        explotaGenkidama.play();
                    }
                    if (Date.now() - bomba.explosionStartTime > explosionDisplayTime) {
                        muros = muros.filter((muro) => {
                            if (muro.destructible && bomba.estaDentroRango(muro)) {
                                score += 100;
                                return false;
                            }
                            return true;
                        });
                        return false; 
                    }
                }
                return true;
            });
        }

    
        function generarObstaculosNoDestructibles(cantidad) {
            for (let i = 0; i < cantidad; i++) {
                let obstaculo;
                do {
                    let x = Math.floor(Math.random() * (myCanvas.width - 40));
                    let y = Math.floor(Math.random() * (myCanvas.height - 40));
                    obstaculo = new Rectangulo(x, y, 40, 40, "black", null, false);
                } while (muros.some(m => m.deteccionColision(obstaculo)));
                muros.push(obstaculo);
            }
        }

    
        function generarObstaculosDestructibles(cantidad) {
            for (let i = 0; i < cantidad; i++) {
                let obstaculo;
                do {
                    let x = Math.floor(Math.random() * (myCanvas.width - 40));
                    let y = Math.floor(Math.random() * (myCanvas.height - 40));
                    obstaculo = new Rectangulo(x, y, 40, 40, "blue", null, true);
                } while (muros.some(m => m.deteccionColision(obstaculo)));
                muros.push(obstaculo);
            }
        }

        function pintar() {
            ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
            if (!gameStarted) {
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, myCanvas.width, myCanvas.height);

                ctx.fillStyle = "rgb(239,223,46)";
                ctx.font = "60px 'DBZ'";
                ctx.textAlign = "center";
                ctx.fillText("Dragon Bomberman Z", myCanvas.width / 2, myCanvas.height / 2 - 50);

                ctx.fillStyle = "rgb(223,31,46)";
                ctx.font = "30px Arial";
                ctx.fillText("Presiona ENTER para empezar", myCanvas.width / 2, myCanvas.height / 2 + 50);
            } else {
                ctx.fillStyle = jugador.fillColor;
                ctx.fillRect(jugador.axisX, jugador.axisY, jugador.width, jugador.height);

                muros.forEach((muro) => {
                    ctx.fillStyle = muro.fillColor;
                    ctx.fillRect(muro.axisX, muro.axisY, muro.width, muro.height);
                });

                bombas.forEach((bomba) => {
                    if (!bomba.exploded) {
                        ctx.drawImage(genkidama, bomba.axisX, bomba.axisY, bomba.size * bomba.scale, bomba.size * bomba.scale);
                    } else if (Date.now() - bomba.explosionStartTime <= explosionDisplayTime) {
                        ctx.drawImage(explosion, bomba.axisX, bomba.axisY, bomba.size * bomba.scale, bomba.size * bomba.scale);
                    }
                });

                document.getElementById("score").innerText = score;
                document.getElementById("time").innerText = Math.floor(time / 1000);

                actualizar();
                time += 16;
                requestAnimationFrame(pintar);
            }
        }

        let score = 0;
        let time = 0;

        generarObstaculosNoDestructibles(10);
        generarObstaculosDestructibles(15);

        pintar();
    </script>
</body>

</html>
